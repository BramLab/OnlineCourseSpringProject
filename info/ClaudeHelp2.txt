
Can you check the code for errors?
12:57

I'll review your code for errors. Here are the issues I found:
Critical Errors
1. CourseServiceImpl - Missing Dependency Injection

In CourseServiceImpl.java, the repositories are declared but not injected:
java

@Service
@Transactional
@RequiredArgsConstructor
public class CourseServiceImpl implements CourseService{

    CourseRepository courseRepository;  // ❌ Not injected!
    UserRepository userRepository;      // ❌ Not injected!

Fix: Add final keyword so @RequiredArgsConstructor can inject them:
java

@Service
@Transactional
@RequiredArgsConstructor
public class CourseServiceImpl implements CourseService{

    private final CourseRepository courseRepository;
    private final UserRepository userRepository;

2. SecurityConfig - Missing Course Endpoints Protection

Your SecurityConfig allows all /api/courses/** endpoints to be public, but according to your requirements:

    POST /api/courses should require INSTRUCTOR/ADMIN
    PUT /api/courses/{id} should require INSTRUCTOR (own) / ADMIN
    DELETE /api/courses/{id} should require ADMIN

Current code:
java

.requestMatchers("/api/courses/**").permitAll() // ❌ Too permissive!

Fix:
java

.authorizeHttpRequests(auth -> auth
    .requestMatchers("/api/auth/**").permitAll()
    .requestMatchers(HttpMethod.GET, "/api/courses/**").permitAll()
    .requestMatchers(HttpMethod.POST, "/api/courses").hasAnyRole("INSTRUCTOR", "ADMIN")
    .requestMatchers(HttpMethod.PUT, "/api/courses/**").hasAnyRole("INSTRUCTOR", "ADMIN")
    .requestMatchers(HttpMethod.DELETE, "/api/courses/**").hasRole("ADMIN")
    .requestMatchers("/api/admin/**").hasRole("ADMIN")
    .anyRequest().authenticated()
)

Don't forget to add the import:
java

import org.springframework.http.HttpMethod;

3. CourseServiceImpl.deleteCourse() - Wrong Authorization Check

In deleteCourse(), you're checking if the user is the instructor,
but according to requirements, only ADMIN can delete courses:
java

@Override
public void deleteCourse(long courseId) {
    Course course = getCourseIfLoggedInUserIsAllowed(courseId);  // ❌ Wrong check!
    courseRepository.delete(course);
}

Fix:
java

@Override
public void deleteCourse(long courseId) {
    // Get current user
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    String currentUsername = authentication.getName();

    User currentUser = userRepository.findByUsername(currentUsername)
        .orElseThrow(() -> new UnauthorizedActionException("User not found"));

    // Only ADMIN can delete
    if (currentUser.getRole() != Role.ADMIN) {
        throw new UnauthorizedActionException("Only admins can delete courses");
    }

    Course course = courseRepository.findById(courseId)
        .orElseThrow(() -> new ResourceNotFoundException("Course not found with id: " + courseId));

    courseRepository.delete(course);
}

4. CourseServiceImpl.getCourseIfLoggedInUserIsAllowed() - Logic Error

This method only allows INSTRUCTORS, but ADMIN should also be able to update any course:
java

if(optionalUser.isEmpty() || optionalUser.get().getRole() != Role.INSTRUCTOR ){
    throw new UnauthorizedActionException("User not found, or you do not have the role instructor.");
}

Fix:
java

private Course getCourseIfLoggedInUserIsAllowed(long courseId) {
    // Find currently logged in user
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    String currentUsername = authentication.getName();

    User currentUser = userRepository.findByUsername(currentUsername)
        .orElseThrow(() -> new UnauthorizedActionException("User not found"));

    // Find course
    Course course = courseRepository.findById(courseId)
        .orElseThrow(() -> new ResourceNotFoundException("Course not found with id: " + courseId));

    // Check authorization: ADMIN can edit any course, INSTRUCTOR only their own
    boolean isAdmin = currentUser.getRole() == Role.ADMIN;
    boolean isOwnCourse = course.getInstructor().getId() == currentUser.getId();

    if (!isAdmin && !isOwnCourse) {
        throw new UnauthorizedActionException("You can only update your own courses");
    }

    return course;
}

5. CourseServiceImpl.updateCourse() - Instructor Assignment Issue

When updating a course, you're not preserving the instructor.
The CourseRequest includes instructorId, but you should not allow
changing the instructor:
java

@Override
public CourseResponse updateCourse(long id, CourseRequest courseRequest) {
    // ... validation code ...

    course.setTitle(courseRequest.title());
    course.setDescription(courseRequest.description());
    course.setStartDate(courseRequest.startDate());
    course.setEndDate(courseRequest.endDate());
    // ❌ Not setting instructor - but that's actually correct!
    // You should NOT allow changing the instructor

This is actually correct as-is, but you should add a comment or remove
 instructorId from updates.


Minor Issues
6. UserConfig.java - Duplicate Student Password
java

User user_student2 = new User(0, "user_student2", "user_student2@c.com", Role.STUDENT
        , passwordEncoder.encode("s1"));  // ❌ Same password as student1

This isn't an error, but for testing, you might want different passwords like "s2".
7. Unused BadRequestException Import

In CourseServiceImpl.java:
java

import org.apache.coyote.BadRequestException;  // ❌ Not used

8. CourseRequest - instructorId shouldn't be in updates

The CourseRequest DTO includes instructorId,
but you don't use it in updates (which is correct).
Consider creating separate DTOs:

    CourseCreateRequest (with instructorId)
    CourseUpdateRequest (without instructorId)

9. Missing @Autowired or Constructor Issue

The getCourseIfLoggedInUserIsAllowed() method catches a generic Exception, which might hide real errors:
java

try{
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    currentUsernameFromSecurityContext = authentication.getName();
}catch(Exception e){  // ❌ Too broad
    throw new UnauthorizedActionException("You are not authenticated. Login (again).");
}

Fix: Be more specific or remove the try-catch (Spring Security handles this):
java

Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
if (authentication == null || !authentication.isAuthenticated()) {
    throw new UnauthorizedActionException("You are not authenticated.");
}
String currentUsername = authentication.getName();

Summary of Required Fixes

    ✅ Add final to CourseServiceImpl repositories
    ✅ Fix SecurityConfig to properly restrict course endpoints
    ✅ Fix deleteCourse to only allow ADMIN
    ✅ Fix getCourseIfLoggedInUserIsAllowed to allow ADMIN
    Remove unused imports

Would you like me to provide the complete corrected files for any of these classes?


Claude is AI and can make mistakes. Please double-check responses.

